package test

/**
 * @author Yura Zhloba <yzh44yzh@gmail.com>
 */

import com.yzh44yzh.scalaAmf._
import org.scalatest.FunSuite
import java.util.Date

class TestAmfObj extends FunSuite
{
    // anonymous object
    def createObj1() : AmfClass = {
        val obj = new AmfClass
        obj.put("name", "Bob")
        obj.put("gender", 1)
        obj.put("age", 25)
        obj
    }
    val obj1 = createObj1()
    val buf1 = BufUtils.mkb(0x0a, 0x0b, // Object
			0x01,
			0x09, 0x6e, 0x61, 0x6d, 0x65, // name
			0x06, 0x07, 0x42, 0x6f, 0x62, // Bob
			0x0d, 0x67, 0x65, 0x6e, 0x64, 0x65, 0x72, // gender
			0x04, 0x01, // 1
			0x07, 0x61, 0x67, 0x65, // age
			0x04, 0x19, // 25
			0x01)


    // anonymous object with inner anonymous object
    def createObj2() : AmfClass = {
        val location = new AmfClass
        location.put("country", "Belarus")
        location.put("city", "Minsk")

        val obj = new AmfClass
        obj.put("location", location)
        obj.put("name", "Yura")
        obj
    }
    val obj2 = createObj2()
    val buf2 = BufUtils.mkb(0x0a, 0x0b, // Object
			0x01,
			0x11, 0x6c, 0x6f, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, // location
			0x0a, // inner Object
                0x01,
                0x0f, 0x63, 0x6f, 0x75, 0x6e, 0x74, 0x72, 0x79, // country
                0x06, 0x0f, 0x42, 0x65, 0x6c, 0x61, 0x72, 0x75, 0x73, // Belarus
                0x09, 0x63, 0x69, 0x74, 0x79, // city
                0x06, 0x0b, 0x4d, 0x69, 0x6e, 0x73, 0x6b, // Minsk
                0x01, // end of inner Object
			0x09, 0x6e, 0x61, 0x6d, 0x65, // name
			0x06, 0x09, 0x59, 0x75, 0x72, 0x61, // Yura
			0x01)


    // AS3 class (not registered)
    def createObj3() : AmfClass = {
        val obj = new AmfClass
        obj.put("id", 25)
        obj.put("date", new Date(1289767440000L))
        obj.put("sender", "Bob")
        obj.put("content", "Hello")
        obj
    }
    val obj3 = createObj3()
    val buf3 = BufUtils.mkb(0xa, 0x43,
            0x1, // empty class name
            0x5, 0x69, 0x64, // id
            0x9, 0x64, 0x61, 0x74, 0x65, // date
            0xd, 0x73, 0x65, 0x6e, 0x64, 0x65, 0x72, // sender
            0xf, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, // content
            0x4, 0x19, // 25
            0x08, 0x01, 0x42, 0x72, -0x3c, -0x3e, 0x14, -0x18, 0x00, 0x0, // Sun Nov 14 22:44:00 GMT+0200 2010
            0x6, 0x7, 0x42, 0x6f, 0x62, // Bob
            0x6, 0xb, 0x48, 0x65, 0x6c, 0x6c, 0x6f // Hello
     )
    val buf3enc = BufUtils.mkb(0xa, 0xb,
            0x1, 
            0x5, 0x69, 0x64, // id
            0x4, 0x19, // 25
            0x9, 0x64, 0x61, 0x74, 0x65, // date
            0x08, 0x01, 0x42, 0x72, -0x3c, -0x3e, 0x14, -0x18, 0x00, 0x0, // Sun Nov 14 22:44:00 GMT+0200 2010
            0xd, 0x73, 0x65, 0x6e, 0x64, 0x65, 0x72, // sender
            0x6, 0x7, 0x42, 0x6f, 0x62, // Bob
            0xf, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, // content
            0x6, 0xb, 0x48, 0x65, 0x6c, 0x6c, 0x6f, // Hello
            0x1
     )


    // AS3 class (registered)
    def createObj4() : AmfClass = {
        val obj = new AmfClass
        obj.className = "some.pack.Message"
        obj.put("isPrivate", true)
        obj.put("id", 25)
        obj.put("content", "Hello")
        obj.put("sender", "Bob")
        obj
    }
    val obj4 = createObj4()
    val buf4 = BufUtils.mkb(0xa, 0x43,
            0x23, // className string length
            0x73, 0x6f, 0x6d, 0x65, 0x2e, // some.
            0x70, 0x61, 0x63, 0x6b, 0x2e, // pack.
            0x4d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, // Message
            0x13, 0x69, 0x73, 0x50, 0x72, 0x69, 0x76, 0x61, 0x74, 0x65, // isPrivate
            0x5, 0x69, 0x64, // id
            0xf, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, // content
            0xd, 0x73, 0x65, 0x6e, 0x64, 0x65, 0x72, // sender
            0x3, // true
            0x4, 0x19, // 25
            0x6, 0xb, 0x48, 0x65, 0x6c, 0x6c, 0x6f, // Hello
            0x6, 0x7, 0x42, 0x6f, 0x62 // Bob
    )


    // anonymous object with inner AS class
    def createObj5() : AmfClass = {
        val obj = new AmfClass
        obj.className = "some.pack.Message"
        obj.put("id", 25)
        obj.put("content", "Hello")
        obj.put("sender", "Bob")

        val obj2 = new AmfClass
        obj2.put("message", obj)
        obj2.put("request", 24)
        obj2.put("action", "sendMessage")
        obj2
    }
    val obj5 = createObj5()
    val buf5 = BufUtils.mkb(0xa, 0xb,
            0x1,
            0xf, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, // message
            0xa, 0x33,
                 0x23,
                 0x73, 0x6f, 0x6d, 0x65, 0x2e, // some.
                 0x70, 0x61, 0x63, 0x6b, 0x2e, // pack.
                 0x4d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, // Message
                 0x5, 0x69, 0x64, // id
                 0xf, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, // content
                 0xd, 0x73, 0x65, 0x6e, 0x64, 0x65, 0x72, // sender
                 0x4, 0x19, // 25
                 0x6, 0xb, 0x48, 0x65, 0x6c, 0x6c, 0x6f, // Hello
                 0x6, 0x7, 0x42, 0x6f, 0x62, // Bob
            0xf, 0x72, 0x65, 0x71, 0x75, 0x65, 0x73, 0x74, // request
            0x4, 0x18, // 24
            0xd, 0x61, 0x63, 0x74, 0x69, 0x6f, 0x6e, // action
            0x6, 0x17, 0x73, 0x65, 0x6e, 0x64, 0x4d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, // sendMessage
            0x1
    )


    // AS class with inner anonymous object
    def createObj6() : AmfClass = {
        val obj2 = new AmfClass
        obj2.put("gender", "male")
        obj2.put("age", 32)

        val obj = new AmfClass
        obj.className = "some.pack.User"
        obj.put("attributes", obj2)
        obj.put("name", "Bill")
        obj.put("id", 234)
        obj
    }
    val obj6 = createObj6()
    val buf6 = BufUtils.mkb(0xa, 0x33,
            0x1d,
            0x73, 0x6f, 0x6d, 0x65, 0x2e, // some.
            0x70, 0x61, 0x63, 0x6b, 0x2e, // pack.
            0x55, 0x73, 0x65, 0x72, // User
            0x15, 0x61, 0x74, 0x74, 0x72, 0x69, 0x62, 0x75, 0x74, 0x65, 0x73, // attributes
            0x9, 0x6e, 0x61, 0x6d, 0x65, // name
            0x5, 0x69, 0x64, // id
                0xa,
                0x1,
                0xd, 0x67, 0x65, 0x6e, 0x64, 0x65, 0x72, // gender
                0x6, 0x9, 0x6d, 0x61, 0x6c, 0x65, // male
                0x7, 0x61, 0x67, 0x65, // age
                0x4, 0x20, // 32
                0x1,
            0x6, 0x9, 0x42, 0x69, 0x6c, 0x6c, // Bill
            0x4, -0x7f, 0x6a // 234
    )


    // AS class with inner AS class
    def createObj7() : AmfClass = {
        val obj = new AmfClass
        obj.className = "some.pack.User"
        obj.put("age", 44)
        obj.put("name", "John")
        obj.put("id", 2)
        obj.put("admin", true)

        val obj2 = new AmfClass
        obj2.className = "some.pack.Message"
        obj2.put("content", "How are you? :)")
        obj2.put("sender", obj)
        obj2
    }
    val obj7 = createObj7()
    val buf7 = BufUtils.mkb(0xa, 0x23,
            0x23,
            0x73, 0x6f, 0x6d, 0x65, 0x2e, // some.
            0x70, 0x61, 0x63, 0x6b, 0x2e, // pack.
            0x4d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, // Message
            0xf, 0x63, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, // content
            0xd, 0x73, 0x65, 0x6e, 0x64, 0x65, 0x72, // sender
            0x6, 0x1f,
            0x48, 0x6f, 0x77, 0x20, // How
            0x61, 0x72, 0x65, 0x20, // are
            0x79, 0x6f, 0x75, 0x3f, 0x20, 0x3a, 0x29, // you? :)
                0xa, 0x43,
                0x1d,
                0x73, 0x6f, 0x6d, 0x65, 0x2e, // some.
                0x70, 0x61, 0x63, 0x6b, 0x2e, // pack.
                0x55, 0x73, 0x65, 0x72, // User
                0x7, 0x61, 0x67, 0x65, // age
                0x9, 0x6e, 0x61, 0x6d, 0x65, // name
                0x5, 0x69, 0x64, // id
                0xb, 0x61, 0x64, 0x6d, 0x69, 0x6e, // admin
                0x4, 0x2c, // 44
                0x6, 0x9, 0x4a, 0x6f, 0x68, 0x6e, // John
                0x4, 0x2, // 2
                0x3 // true
    )

    // 2 inner objects
    def createObj8() : AmfClass = {
        val obj1 = new AmfClass();
        obj1.put("name", "Bob");
        obj1.put("id", 1);

        val obj2 = new AmfClass();
        obj2.put("name", "Bill");
        obj2.put("id", 2);
        obj2.put("age", 25);

        val obj = new AmfClass()
        obj.put("user2", obj2);
        obj.put("user1", obj1);
        obj
    }
    val obj8 = createObj8()
    val buf8 = BufUtils.mkb(0xa, 0xb, 0x1,
            0xb, 0x75, 0x73, 0x65, 0x72, 0x32, // user2
            0xa, 0x1,
                0x9, 0x6e, 0x61, 0x6d, 0x65, // name
                0x6, 0x9, 0x42, 0x69, 0x6c, 0x6c, // Bill
                0x5, 0x69, 0x64, // id
                0x4, 0x2, // id:2
                0x7, 0x61, 0x67, 0x65, // age
                0x4, 0x19, // 25
                0x1,
            0xb, 0x75, 0x73, 0x65, 0x72, 0x31, // user1
            0xa, 0x1,
                0x2, // ref to name
                0x6, 0x7, 0x42, 0x6f, 0x62, // Bob
                0x6, // ref to id
                0x4, 0x1, // id:1
                0x1,
            0x1
    )

    test("decode objects")
    {
        val (AmfType.OBJECT, res1) = Amf.decode(buf1)
        assert(obj1.equals(res1))

        val (AmfType.OBJECT, res2) = Amf.decode(buf2)
        assert(obj2.equals(res2))

        val (AmfType.OBJECT, res3) = Amf.decode(buf3)
        assert(obj3.equals(res3))

        val (AmfType.OBJECT, res4) = Amf.decode(buf4)
        assert(obj4.equals(res4))
        assert(res4.asInstanceOf[AmfClass].className.equals("some.pack.Message"))

        val (AmfType.OBJECT, res5) = Amf.decode(buf5)
        assert(obj5.equals(res5))

        val (AmfType.OBJECT, res6) = Amf.decode(buf6)
        assert(obj6.equals(res6))

        val (AmfType.OBJECT, res7) = Amf.decode(buf7)
        assert(obj7.equals(res7))

        val (AmfType.OBJECT, res8) = Amf.decode(buf8)
        assert(obj8.equals(res8))
    }
    
    test("encode objects")
    {
        assert(BufUtils.eq(Amf.encode((AmfType.OBJECT, obj1)), buf1))
        assert(BufUtils.eq(Amf.encode((AmfType.OBJECT, obj2)), buf2))
        assert(BufUtils.eq(Amf.encode((AmfType.OBJECT, obj3)), buf3enc))
        assert(BufUtils.eq(Amf.encode((AmfType.OBJECT, obj4)), buf4))
        assert(BufUtils.eq(Amf.encode((AmfType.OBJECT, obj5)), buf5))
        assert(BufUtils.eq(Amf.encode((AmfType.OBJECT, obj6)), buf6))
        assert(BufUtils.eq(Amf.encode((AmfType.OBJECT, obj7)), buf7))
        assert(BufUtils.eq(Amf.encode((AmfType.OBJECT, obj8)), buf8))
    }
}
